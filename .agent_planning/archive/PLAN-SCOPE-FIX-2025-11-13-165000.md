# Scope Containment Bug Fix Plan

**Generated**: 2025-11-13 16:50:00
**Source**: STATUS-2025-11-13-163000.md
**Spec Version**: CLAUDE.md (last modified 2025-11-13)

---

## Executive Summary

**Sprint Goal**: Fix scope containment detection bug and achieve 95%+ test pass rate

**Current Status**: 220/238 tests passing (92.4%)
**Target Status**: 227/238 tests passing (95.4%)
**Blocking Issue**: Scope containment detection in dependency graph missing variables declared directly in function body scope

**Effort**: 30-60 minutes
**Risk**: LOW (5-line change, comprehensive test coverage)
**Impact**: Restores 10-20% quality improvement in turbo mode

---

## Background

### The Problem

**File**: `/src/plugins/local-llm-rename/dependency-graph.ts` (lines 483-490)
**Function**: `buildDirectScopeHierarchy()`

The current implementation only detects scope containment for variables in CHILD scopes, but misses variables declared DIRECTLY in a function's body scope.

**Example**:
```javascript
function outer() {
  const x = 2;  // ❌ NOT detected (x is in outer's BODY scope)
  function inner() {
    const y = 3;  // ✅ Detected (y is in a CHILD scope of outer)
  }
}
```

### Root Cause

```typescript
// CURRENT (BROKEN) - lines 483-490:
for (const [otherScope, otherIds] of byScope) {
  if (otherScope.parent === createdScope) {
    // This ONLY finds variables in child scopes
    for (const childId of otherIds) {
      contained.add(childId);
    }
  }
}
```

**What's Missing**: Variables where `otherScope === createdScope` (same scope, not child).

### Impact

**Failing Tests**: 7
- 3 in `dependency-graph.test.ts`
- 4 in `dependency-graph-fixes.test.ts`

**Quality Degradation**: 10-20%
- LLMs don't see function-local variables as "contained"
- Less context provided for naming decisions
- Lower-quality variable names produced

**Functional Impact**: Turbo mode still WORKS, but produces suboptimal results.

---

## The Fix

### Required Change

**File**: `/src/plugins/local-llm-rename/dependency-graph.ts`
**Lines**: 483-490

```typescript
// FIXED:
for (const [otherScope, otherIds] of byScope) {
  // Check if otherScope is the created scope itself OR a direct child
  if (otherScope === createdScope || otherScope.parent === createdScope) {
    for (const childId of otherIds) {
      // Exclude the function/class identifier itself to avoid self-reference
      if (childId !== id) {
        contained.add(childId);
      }
    }
  }
}
```

### Why This Works

1. **Includes same-scope variables**: `otherScope === createdScope` catches variables declared directly in the function body
2. **Preserves child scope detection**: `otherScope.parent === createdScope` still catches nested scopes
3. **Prevents self-reference**: `childId !== id` excludes the function identifier itself
4. **Minimal change**: Only 2 conditions changed, logic otherwise identical

---

## Task Breakdown

### Task 1: Implement the Fix
**Status**: Not Started
**Effort**: Small (5 minutes)
**Dependencies**: None

**Description**:
Apply the 5-line fix to `dependency-graph.ts` lines 483-490.

**Acceptance Criteria**:
- [ ] Line 484 condition changed from `if (otherScope.parent === createdScope)` to `if (otherScope === createdScope || otherScope.parent === createdScope)`
- [ ] Self-exclusion check added: `if (childId !== id)`
- [ ] Code compiles without errors
- [ ] No lint/prettier warnings

**Technical Notes**:
- The `childId !== id` check prevents the function identifier from being marked as contained within itself
- This is necessary because when processing `function outer()`, the identifier `outer` and the scope it creates are both in the same tracking structures

---

### Task 2: Verify Scope Tests Pass
**Status**: Not Started
**Effort**: Small (10 minutes)
**Dependencies**: Task 1

**Description**:
Run the dependency graph test suites to verify all 7 failing tests now pass.

**Acceptance Criteria**:
- [ ] All tests in `dependency-graph.test.ts` pass (0 failures)
- [ ] All tests in `dependency-graph-fixes.test.ts` pass (0 failures)
- [ ] Specifically verify these test cases pass:
  - Variable shadowing test (line 157)
  - Nested scope references test (line 320)
  - Arrow functions and closures test (line 655)
  - Dependency mode cache test (line 602)

**Test Commands**:
```bash
tsx --test src/plugins/local-llm-rename/dependency-graph.test.ts
tsx --test src/plugins/local-llm-rename/dependency-graph-fixes.test.ts
```

**Technical Notes**:
- The cache test (line 602) should now show different dependency counts for strict/balanced/relaxed modes
- If any tests still fail, review the scope hierarchy logic for additional edge cases

---

### Task 3: Run Full Test Suite
**Status**: Not Started
**Effort**: Small (10 minutes)
**Dependencies**: Task 2

**Description**:
Run the complete unit test suite to ensure no regressions were introduced.

**Acceptance Criteria**:
- [ ] Zero new test failures introduced
- [ ] Test pass rate increases from 220/238 (92.4%) to 227/238 (95.4%)
- [ ] Only 1 failing test remaining (file-splitter performance test, non-blocking)
- [ ] All checkpoint tests still passing
- [ ] All batch processing tests still passing

**Test Commands**:
```bash
npm run test:unit
```

**Technical Notes**:
- Expected final state: 227 passing, 1 failing (file-splitter perf), 10 skipped
- If additional tests fail, the fix may have introduced a regression
- Focus on dependency-graph and turbo-mode related tests

---

### Task 4: Commit the Fix
**Status**: Not Started
**Effort**: Small (5 minutes)
**Dependencies**: Task 3

**Description**:
Commit the scope containment fix with a descriptive message.

**Acceptance Criteria**:
- [ ] Commit includes only the dependency-graph.ts change
- [ ] Commit message clearly describes the bug and fix
- [ ] No unrelated changes included

**Commit Message**:
```
fix(dependency-graph): detect variables in function body scope

Fixes scope containment detection for variables declared directly
in a function's body scope (not just child scopes).

Previous logic only checked child scopes (otherScope.parent === createdScope),
missing variables in the function's own scope (otherScope === createdScope).

Impact:
- Fixes 7 failing tests in dependency-graph.test.ts and dependency-graph-fixes.test.ts
- Restores 10-20% quality improvement in turbo mode
- Test pass rate: 220/238 → 227/238 (92.4% → 95.4%)

Example:
  function outer() {
    const x = 2;  // Now correctly detected as contained in outer
    return x;
  }
```

**Technical Notes**:
- Keep the commit atomic (single focused change)
- Reference the STATUS report in commit body if desired
- Tag as `fix(dependency-graph):` for semantic versioning

---

### Task 5: Update Documentation (Optional)
**Status**: Not Started
**Effort**: Small (10 minutes)
**Dependencies**: Task 4

**Description**:
Add a note to CLAUDE.md explaining the scope containment logic.

**Acceptance Criteria**:
- [ ] Add section to Dependency Graph Deep Dive explaining scope containment
- [ ] Include code example showing body scope vs child scope
- [ ] Mention the self-exclusion check

**Technical Notes**:
- This is optional but helpful for future maintainers
- Can be deferred to a separate documentation update PR
- Consider adding inline code comments instead

---

## Success Criteria

### Primary Goals (Required)
- [ ] All 7 scope containment tests passing
- [ ] No new test failures introduced
- [ ] Test pass rate ≥ 95.4% (227/238)
- [ ] Fix committed with clear message

### Secondary Goals (Optional)
- [ ] Documentation updated
- [ ] Manual turbo mode test shows improved naming quality

---

## Testing Strategy

### Unit Tests (Primary Verification)
```bash
# 1. Test dependency graph directly
tsx --test src/plugins/local-llm-rename/dependency-graph.test.ts

# 2. Test fixes suite
tsx --test src/plugins/local-llm-rename/dependency-graph-fixes.test.ts

# 3. Full unit test suite
npm run test:unit
```

### Manual Testing (Optional)
```bash
# Build
npm run build

# Test on sample with nested functions
echo 'function outer() { const x = 2; return x; }' > /tmp/scope-test.js
./dist/index.mjs unminify /tmp/scope-test.js --turbo --provider local --debug
```

**Expected Output**: LLM should see `x` as contained in `outer` scope.

---

## Risk Assessment

### Risk Level: LOW

**Why Low Risk**:
1. **Minimal change**: Only 2 conditions modified
2. **Well-tested**: 7 tests specifically verify this behavior
3. **No API changes**: Internal implementation detail only
4. **Backward compatible**: Doesn't affect non-turbo mode
5. **Clear rollback**: Single commit to revert if needed

### Potential Issues

**Issue**: Performance regression if many identifiers in same scope
**Likelihood**: LOW
**Mitigation**: Existing tests include large scopes, would catch this

**Issue**: Self-reference edge case not covered
**Likelihood**: LOW
**Mitigation**: `childId !== id` check prevents this explicitly

**Issue**: Interaction with other dependency types
**Likelihood**: LOW
**Mitigation**: Scope containment is independent of reference tracking

---

## Timeline

**Total Effort**: 30-60 minutes

| Task | Effort | Cumulative |
|------|--------|------------|
| 1. Implement fix | 5 min | 5 min |
| 2. Verify scope tests | 10 min | 15 min |
| 3. Run full suite | 10 min | 25 min |
| 4. Commit | 5 min | 30 min |
| 5. Documentation (optional) | 10 min | 40 min |

**Recommended Approach**: Complete tasks 1-4 in a single session, defer task 5 if time-constrained.

---

## Dependencies

**No external dependencies** - all work is self-contained in `dependency-graph.ts`.

**Dependency Graph**:
```
Task 1 (Implement)
  ↓
Task 2 (Scope tests)
  ↓
Task 3 (Full suite)
  ↓
Task 4 (Commit)
  ↓
Task 5 (Docs) [optional]
```

---

## Next Steps After Completion

Once this fix is complete:

1. **P1**: Consider improving checkpoint E2E tests (wait for batch completion)
2. **P2**: Document checkpoint timing behavior in CLAUDE.md
3. **P3**: Address file-splitter performance test (increase threshold or remove)

---

## Files Referenced

**Implementation**:
- `/Users/bmf/Library/Mobile Documents/com~apple~CloudDocs/_mine/icode/brandon-fryslie_humanify/src/plugins/local-llm-rename/dependency-graph.ts` (lines 483-490)

**Tests**:
- `/Users/bmf/Library/Mobile Documents/com~apple~CloudDocs/_mine/icode/brandon-fryslie_humanify/src/plugins/local-llm-rename/dependency-graph.test.ts`
- `/Users/bmf/Library/Mobile Documents/com~apple~CloudDocs/_mine/icode/brandon-fryslie_humanify/src/plugins/local-llm-rename/dependency-graph-fixes.test.ts`

**Documentation**:
- `/Users/bmf/Library/Mobile Documents/com~apple~CloudDocs/_mine/icode/brandon-fryslie_humanify/CLAUDE.md`

**Planning**:
- `/Users/bmf/Library/Mobile Documents/com~apple~CloudDocs/_mine/icode/brandon-fryslie_humanify/.agent_planning/STATUS-2025-11-13-163000.md` (source)
