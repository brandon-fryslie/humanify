# Definition of Done: Scoring Infrastructure Refactor

**Generated**: 2025-12-31-002756
**Plan**: PLAN-2025-12-31-002756.md
**Topic**: Dynamic Mode Discovery for 5-10+ Turbo Variations

---

## Sprint Scope

This sprint delivers **2 core deliverables**:
1. Dynamic mode discovery (replace hardcoded mode lists)
2. Mode configuration registry (single source of truth for 8+ modes)

**Deferred**: Justfile recipe generation (P2 — nice-to-have, not critical)

---

## Acceptance Criteria

### Deliverable 1: Dynamic Mode Discovery

**Goal**: Eliminate hardcoded mode lists in scoring scripts.

#### Core Functionality
- [ ] `run-semantic-scoring-all.sh` discovers modes dynamically by scanning `test-samples/canonical/tiny-qs/output-*` directories
- [ ] Mode discovery extracts mode name from directory name (strip `output-` prefix)
- [ ] Script runs successfully with existing 4 modes (sequential, turbo, turbo-refine, turbo-v2)
- [ ] Script automatically discovers new modes when new `output-{mode}/` directories are created
- [ ] No hardcoded mode lists remain in scoring scripts (except documentation examples)

#### Error Handling
- [ ] Script handles missing mode directories gracefully (logs skip message, continues processing other modes)
- [ ] Script fails with clear error if NO output directories found in discovery sample
- [ ] Skipped modes are logged to console (e.g., "[SKIP] small-axios/turbo-v2-balanced - output file not found")

#### Backward Compatibility
- [ ] Existing workflows unchanged (same command, same output)
- [ ] Justfile recipes work as-is (generic `just score <sample> <mode>` already exists)
- [ ] Output file fallback (output.js → deobfuscated.js) continues to work
- [ ] Summary table in `run-semantic-scoring-all.sh` still displays (may need dynamic columns)

#### Testing
- [ ] Unit test: Mode discovery with mock directory structure (4 modes)
- [ ] Integration test: Run scoring with existing 4 modes → verify same output as before
- [ ] Integration test: Create `test-samples/canonical/tiny-qs/output-turbo-v2-balanced/output.js` → verify auto-discovery and scoring
- [ ] Edge case test: Delete one mode from one sample → verify graceful skip

#### Documentation
- [ ] `scripts/score-sample.sh` documentation updated to say "modes auto-discovered from output directories"
- [ ] Code comments explain discovery logic

---

### Deliverable 2: Mode Configuration Registry

**Goal**: Central source of truth for mode metadata and execution commands.

#### Core Functionality
- [ ] `scripts/mode-registry.json` exists with 8 mode definitions:
  - Existing: `sequential`, `turbo`, `turbo-refine`, `turbo-v2`
  - New: `turbo-v2-balanced`, `turbo-v2-quality`, `turbo-v2-anchor`, `turbo-v2-thorough`
- [ ] Each mode entry includes required fields:
  - `command` (template string with `{{input}}`, `{{output}}`, `{{preset}}`, `{{concurrency}}`)
  - `description` (human-readable summary)
  - `defaults` (object with default parameter values)
  - `passes` (number of passes for this mode)
- [ ] Mode naming convention: `turbo-v2-{preset}` for all turbo-v2 preset variations
- [ ] Registry validates on load (JSON schema, no duplicate mode names)

#### Helper Scripts
- [ ] `scripts/list-modes.sh` lists all modes with descriptions and pass counts
- [ ] `scripts/list-modes.sh` output format: table with columns (Mode, Description, Passes)
- [ ] `scripts/run-mode.sh <sample> <mode>` executes mode from registry
- [ ] `scripts/run-mode.sh` performs parameter substitution (`{{input}}` → actual path, etc.)
- [ ] `scripts/run-mode.sh` validates mode exists in registry before execution
- [ ] `scripts/validate-registry.sh` validates JSON schema and command template syntax

#### Mode Definitions
- [ ] All 8 modes have correct command templates matching justfile recipes
- [ ] Turbo-v2 preset modes use `--turbo-v2 --preset {preset}` flag
- [ ] Command templates include `--no-chunking` flag for consistency
- [ ] Default parameters are documented (e.g., concurrency defaults)

#### Testing
- [ ] Unit test: Validate registry JSON schema (required fields, valid JSON)
- [ ] Unit test: Test command template substitution with mock parameters
- [ ] Integration test: Run `list-modes.sh` → verify 8 modes listed
- [ ] Integration test: Run `run-mode.sh tiny-qs turbo-v2-balanced` → verify execution and output
- [ ] Integration test: Run `validate-registry.sh` → verify no errors

#### Documentation
- [ ] `scripts/README.md` created with mode addition workflow:
  1. Add mode to `mode-registry.json`
  2. Run `scripts/validate-registry.sh` to verify
  3. Create output directories via processing scripts
  4. Run scoring scripts (auto-discover new mode)
- [ ] Registry schema documented in `scripts/README.md`
- [ ] Template variable reference documented (`{{input}}`, `{{output}}`, etc.)

---

## Integration Testing

### End-to-End Workflow
- [ ] Create new turbo-v2 preset mode:
  1. Add `turbo-v2-balanced` to registry
  2. Run `humanify unminify --turbo-v2 --preset balanced` on tiny-qs
  3. Run `scripts/run-semantic-scoring-all.sh`
  4. Verify `turbo-v2-balanced` discovered and scored automatically

### Backward Compatibility
- [ ] All existing justfile recipes work unchanged
- [ ] `just score-all` executes without errors
- [ ] Existing scoring output files unchanged
- [ ] No breaking changes to CLI or API

---

## Non-Functional Requirements

### Code Quality
- [ ] All scripts pass shellcheck (bash linting)
- [ ] All JSON files pass jq validation
- [ ] Code follows existing project style (bash script conventions)
- [ ] Clear error messages for all failure cases

### Performance
- [ ] Mode discovery adds <100ms to script startup time
- [ ] No performance regression in scoring scripts
- [ ] Registry loading is lazy (only when needed)

### Maintainability
- [ ] Clear separation of concerns (discovery vs. registry vs. scoring)
- [ ] Helper scripts are reusable (can be called from justfile or other scripts)
- [ ] Registry schema is extensible (can add new fields without breaking)

---

## Deferred Items

These are explicitly OUT OF SCOPE for this sprint:

- [ ] DEFERRED: Justfile recipe generation from registry
- [ ] DEFERRED: Auto-sync registry with `src/turbo-v2/cli/presets.ts`
- [ ] DEFERRED: Per-mode concurrency configuration
- [ ] DEFERRED: Advanced mode parameterization (custom flags)
- [ ] DEFERRED: Mode dependency tracking (e.g., turbo-v2 requires turbo-v2 binary)

---

## Definition of Done Checklist

### Code Complete
- [ ] P0: Dynamic mode discovery implemented
- [ ] P1: Mode registry implemented with 8 modes
- [ ] All acceptance criteria met (both deliverables)
- [ ] All tests passing (unit + integration)

### Documented
- [ ] Code comments added to modified scripts
- [ ] `scripts/README.md` created with mode addition workflow
- [ ] STATUS file updated with implementation results

### Tested
- [ ] Unit tests for mode discovery
- [ ] Unit tests for registry validation
- [ ] Integration tests for end-to-end workflow
- [ ] Edge case testing (missing files, invalid modes)
- [ ] Backward compatibility verified

### Validated
- [ ] Manual test: Add new mode → verify auto-discovery
- [ ] Manual test: Run scoring on all 8 modes
- [ ] Manual test: Existing workflows unchanged
- [ ] Review: Code review by maintainer (if applicable)

### Ready for Use
- [ ] No blocking bugs
- [ ] No performance regressions
- [ ] Documentation complete
- [ ] Ready for production use

---

## Success Criteria

**This sprint is SUCCESSFUL if:**

1. Adding a new turbo-v2 preset mode requires ZERO script edits:
   - Add mode to registry JSON (1 file)
   - Create output directory via processing
   - Scoring scripts auto-discover and process

2. All 8 modes (4 existing + 4 new) are:
   - Defined in registry
   - Auto-discovered by scoring scripts
   - Executable via `run-mode.sh`
   - Documented with descriptions

3. Backward compatibility maintained:
   - Existing workflows unchanged
   - No breaking changes
   - All existing tests pass

**Validation**: Create `turbo-v2-balanced` mode end-to-end without editing scoring scripts.

---

## Known Limitations

1. **Assumption**: All samples have same modes (discovery uses single sample)
   - **Mitigation**: Document assumption, add validation test

2. **Manual sync**: Registry requires manual updates when presets.ts changes
   - **Mitigation**: Document sync process, add validation reminder

3. **No tab-completion**: Generic recipes don't offer mode-specific tab-completion
   - **Mitigation**: Deferred to P2 (justfile generation)

---

**Sprint Ready**: ✅ All criteria are specific, testable, and achievable.
