# Definition of Done: Dashboard Real Data (Final)

**Generated**: 2025-12-31

---

## Sprint Scope

**3 deliverables:**
1. Direct turbo-v2 TypeScript integration
2. Real-time progress via SSE
3. Metrics extraction + cost calculation

---

## Acceptance Criteria

### Deliverable 1: Direct Turbo-V2 Integration

- [ ] `run-experiment.ts` imports `executeTurboV2` directly
- [ ] No shell commands (`execSync`, `spawn` with CLI)
- [ ] `PROJECT_ROOT` resolves paths correctly
- [ ] Sample files found at `test-samples/canonical/{sample}/minified.js`
- [ ] Output written to `.humanify-experiments/{expId}/{sample}/`
- [ ] OPENAI_API_KEY passed from environment

### Deliverable 2: Real-Time Progress

- [ ] `GET /api/experiments/:id/progress` returns SSE stream
- [ ] Events emitted: `pass_started`, `batch_completed`, `pass_completed`, `completed`
- [ ] Ledger watcher polls `events.jsonl` for new events
- [ ] Frontend `useExperimentProgress` hook receives updates
- [ ] Progress bar updates in real-time during execution
- [ ] Shows: pass X/Y, batch N/M, identifiers processed, tokens used
- [ ] Connection closes when job completes or fails

### Deliverable 3: Metrics & Cost

- [ ] `extractMetrics(jobDir)` returns tokens, identifiers, duration
- [ ] Token counts match CLI output (prompt, completion, total)
- [ ] `calculateCost(tokens, model)` returns correct amounts
- [ ] gpt-4o-mini: $0.15/1M input, $0.60/1M output
- [ ] All `SampleResult` fields populated after completion

---

## Sprint Complete When

### Functional
- [ ] Create experiment → click "Run" → turbo-v2 executes
- [ ] Progress bar shows real-time updates during run
- [ ] After completion, all metrics displayed:
  - Score > 0
  - Duration > 0
  - Prompt tokens > 0
  - Completion tokens > 0
  - Cost > 0
  - Identifiers processed > 0
  - Identifiers renamed > 0

### Technical
- [ ] Pure TypeScript (no shell commands)
- [ ] SSE connection works in Chrome/Firefox
- [ ] Ledger watcher cleans up on disconnect
- [ ] Errors handled gracefully

---

## Smoke Test

```
1. Start: cd src/turbo-v2/webapp && npm start
2. Open: http://localhost:3457
3. Create experiment: preset=fast, sample=tiny-qs
4. Click "Run"
5. VERIFY: Progress bar appears and updates
   - Shows "Pass 1/2", "Batch 3/10", etc.
   - Token counter increases
6. Wait for completion (~60-90s)
7. Click "View Details"
8. VERIFY: All fields show real numbers
   - Score: 60-90
   - Tokens: ~15K total
   - Cost: ~$0.01
   - Identifiers: ~100-150
```

---

## Files

**New**:
- `server/api/progress.ts`
- `server/lib/ledger-watcher.ts`
- `server/lib/metrics-extractor.ts`
- `server/lib/cost-calculator.ts`
- `client/hooks/useExperimentProgress.ts`

**Modified**:
- `server/run-experiment.ts`
- `server/index.ts`
- `client/components/ExperimentDetail.tsx`
- `client/components/ExperimentList.tsx`

---

## Estimated Time

**Implementation**: 10-13 hours
**Verification**: 1-2 hours
