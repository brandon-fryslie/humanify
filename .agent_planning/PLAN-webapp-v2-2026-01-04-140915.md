# Webapp v2 Implementation Plan

**Generated**: 2026-01-04-140915
**Source STATUS**: STATUS-2026-01-04-140535.md
**Source Spec**: docs/plans/2026-01-04-webapp-v2-design.md
**Project**: HumanifyJS Developer Workbench v2 (Ground-up Rebuild)

---

## Executive Summary

**Assessment**: This is a **complete rebuild** of the webapp from modal-based to panel-based architecture. Current implementation (6,025 LOC) provides reference material but requires ground-up reconstruction of UI architecture.

**Total Scope**: ~10-15 weeks to feature parity + v2 enhancements
**Total Work Items**: 32 items across 5 phases
**Priority Breakdown**: P0: 8 items | P1: 12 items | P2: 8 items | P3: 4 items

**Recommended Focus**: Complete Phase 1 (Foundation) before proceeding. Panel library choice is make-or-break decision.

**Key Risks**:
- Panel library choice (wrong choice = painful migration)
- State management complexity (panels + tabs + persistence)
- WebSocket scaling (many clients, long-lived connections)

**Clarifications Applied**:
- Panel state: Remember open panels/tabs, reset positions each session
- WebSocket: Simple exponential backoff, max 5 retries
- Command palette: NOT context-sensitive, uses action chaining
- Tabs: No auto-close, user manages manually
- Tree grouping: Default by status, preference NOT stored initially
- Panel drag-drop: Panels CAN move between any zones
- Keyboard shortcuts: Minimal set (Cmd+P, Cmd+W, Cmd+\, Cmd+J)

---

## Phase 1: Foundation (P0 - BLOCKING)

**Goal**: Get basic panel system working with one panel
**Duration**: 2-3 weeks
**Gate**: Can open Experiment Grid in Main zone, move to other zones, persist layout on refresh

---

### [P0] Evaluate and Choose Panel Layout Library

**Status**: Not Started
**Effort**: Small (2-3 days)
**Dependencies**: None
**Spec Reference**: Design Doc §Implementation Notes #1 • **STATUS Reference**: STATUS-2026-01-04-140535.md §Recommended Implementation Order, Phase 1.1

#### Description
Evaluate panel layout libraries and make architectural decision. This is a make-or-break choice - wrong library = painful migration later. Need proof-of-concept validation before proceeding.

**Candidates**:
- `react-grid-layout`: Popular, flexible, good TypeScript support
- `golden-layout`: Mature, complex, tabs built-in
- `react-mosaic`: Lightweight, Palantir-maintained
- `allotment`: VS Code-inspired, split panes

#### Acceptance Criteria
- [ ] Evaluated 3+ libraries with PoC implementations (4-zone layout)
- [ ] Validated support for: tabs within zones, drag-drop panels between zones, TypeScript, state persistence
- [ ] Decision documented with rationale (performance, API, maintenance, bundle size)
- [ ] PoC demonstrates one dummy panel moving between zones
- [ ] State serialization/deserialization working

#### Technical Notes
**Decision criteria** (in priority order):
1. **Tabs support**: All zones must support multiple tabs
2. **Drag-drop**: Panels must move between zones via drag
3. **TypeScript**: Strong typing, no `any` types
4. **Active maintenance**: Last commit <6 months, responsive issues
5. **Bundle size**: <50KB gzipped preferred
6. **API simplicity**: Minimal boilerplate per panel

**Warning**: Do NOT proceed to Phase 2 until this decision is validated with working PoC.

---

### [P0] Implement Core Panel Management System

**Status**: Not Started
**Effort**: Medium (3-5 days)
**Dependencies**: Panel library choice
**Spec Reference**: Design Doc §Panel Management • **STATUS Reference**: STATUS-2026-01-04-140535.md §Recommended Implementation Order, Phase 1.2

#### Description
Build panel infrastructure: registration system, tab management, state persistence. This is the foundation for ALL panels.

**Directory structure**:
```
webapp-v2/
├── client/
│   ├── components/
│   │   ├── layout/
│   │   │   ├── Workspace.tsx         # 4-zone layout container
│   │   │   ├── Zone.tsx              # Left/Main/Right/Bottom zones
│   │   │   ├── PanelContainer.tsx    # Wraps individual panels
│   │   │   └── TabBar.tsx            # Tab management
│   │   └── panels/
│   │       └── (panels go here)
│   ├── state/
│   │   ├── panel-state.ts            # Panel open/close/position state
│   │   └── workspace-persistence.ts  # localStorage integration
│   └── registry/
│       └── panel-registry.ts         # Available panels catalog
```

#### Acceptance Criteria
- [ ] 4-zone layout renders (Left, Main, Right, Bottom)
- [ ] Panel registration system working (can add new panels declaratively)
- [ ] Tab management: can open/close/switch tabs within any zone
- [ ] State persists to localStorage (which panels open, which tabs exist)
- [ ] State resets panel positions on session start (only remembers panels/tabs)
- [ ] Can drag panels between zones
- [ ] Zones are collapsible with visual affordance
- [ ] Unit tests for panel state management (>80% coverage)

#### Technical Notes
**State shape**:
```typescript
interface WorkspaceState {
  version: string;  // For upgrade-safe migrations
  zones: {
    left: { panels: PanelId[], collapsed: boolean };
    main: { tabs: TabId[], activeTab: number };
    right: { panels: PanelId[], collapsed: boolean };
    bottom: { tabs: TabId[], collapsed: boolean };
  };
}
```

**Persistence strategy**:
- On panel open/close: save to localStorage immediately
- On session start: restore panels/tabs, reset positions to defaults
- On version mismatch: graceful degradation (reset to defaults)

---

### [P0] Create webapp-v2 Directory Scaffold

**Status**: Not Started
**Effort**: Small (1 day)
**Dependencies**: None (can parallelize with library evaluation)
**Spec Reference**: Design Doc §Overview • **STATUS Reference**: STATUS-2026-01-04-140535.md §Recommendations #1

#### Description
Set up new `webapp-v2/` directory alongside existing `webapp/`. This is a ground-up rebuild, not a refactor. Keep v1 functional during development.

#### Acceptance Criteria
- [ ] `src/turbo-v2/webapp-v2/` directory created with structure matching Phase 1.2
- [ ] Vite + React 18 + TypeScript configured
- [ ] Vitest + React Testing Library configured for tests
- [ ] Can run `npm run dev` in webapp-v2 directory
- [ ] Port reusable code from v1: `shared/types.ts`, API routes structure
- [ ] Feature flag `--webapp-version v1|v2` added to CLI (runs on different ports)
- [ ] README.md documenting setup, architecture, and differences from v1

#### Technical Notes
**Port from v1** (can copy/adapt):
- `shared/types.ts` (364 LOC) - Excellent foundation
- Backend storage structure (`server/storage.ts`)
- Backend API routes (`server/api/*`)

**Do NOT port**:
- Any modal components
- App.tsx root structure
- SSE infrastructure (will use WebSocket instead)

---

### [P0] Add WebSocket Server Infrastructure

**Status**: Not Started
**Effort**: Medium (3-4 days)
**Dependencies**: webapp-v2 scaffold
**Spec Reference**: Design Doc §Implementation Notes #1 (WebSocket for real-time) • **STATUS Reference**: STATUS-2026-01-04-140535.md §Recommended Implementation Order, Phase 1.4

#### Description
Replace SSE (Server-Sent Events) with WebSocket for bidirectional real-time communication. Keep REST API alongside WebSocket.

**Why WebSocket over SSE**:
- Bidirectional (future: cancel run, pause run)
- Lower overhead for frequent updates
- Better reconnection semantics
- Industry standard for real-time apps

#### Acceptance Criteria
- [ ] WebSocket server endpoint at `/ws` (using `ws` library)
- [ ] Connection pooling per experiment (multiple clients can watch same experiment)
- [ ] Heartbeat/ping-pong to detect stale connections (every 30s)
- [ ] Reconnection logic: exponential backoff (1s, 2s, 4s, 8s, 16s), max 5 retries
- [ ] Can stream progress updates for experiment runs
- [ ] Client hook `useWebSocket(experimentId)` abstracts connection management
- [ ] Old SSE code marked deprecated (don't remove yet, for backwards compat)
- [ ] Integration test: 10 concurrent connections watching same experiment

#### Technical Notes
**Message protocol** (JSON over WebSocket):
```typescript
// Client → Server
{ type: 'subscribe', experimentId: string }
{ type: 'unsubscribe', experimentId: string }

// Server → Client
{ type: 'progress', experimentId: string, data: ProgressUpdate }
{ type: 'complete', experimentId: string, data: RunResult }
{ type: 'error', experimentId: string, error: string }
```

**Reconnection strategy** (per clarification):
- Exponential backoff: 1s, 2s, 4s, 8s, 16s
- Max retries: 5
- After max retries: show "Connection lost" UI, manual reconnect button

---

### [P0] Migrate Experiment Grid to Panel

**Status**: Not Started
**Effort**: Small (2 days)
**Dependencies**: Panel management system
**Spec Reference**: Design Doc §Experiment Grid • **STATUS Reference**: STATUS-2026-01-04-140535.md §Priority 2

#### Description
Extract `ExperimentList.tsx` from modal context and wrap in panel container. This validates the panel system with real content.

**Reuse potential**: 70% (current grid is solid, just needs panel wrapper)

#### Acceptance Criteria
- [ ] `ExperimentGridPanel.tsx` component created
- [ ] Grid content extracted from `ExperimentList.tsx` (keep filtering, sorting, pagination logic)
- [ ] Panel header added (title, search, filters dropdown)
- [ ] Single-click row → emit `onExperimentSelected` event (for Inspector update)
- [ ] Double-click row → emit `onExperimentOpenDetail` event (for Detail tab)
- [ ] Panel can be opened via panel registry
- [ ] Panel can be moved between zones
- [ ] Panel state persists (which filters applied, sort order)
- [ ] Unit tests for grid logic (filtering, sorting, pagination)

#### Technical Notes
**Events emitted** (don't call modals directly):
- `onExperimentSelected(experimentId)`: Updates Inspector
- `onExperimentOpenDetail(experimentId)`: Opens Detail tab in Main zone
- `onExperimentRun(experimentId)`: Starts new run (command palette handles this)

**Remove from v1 implementation**:
- Modal triggers (`setDetailOpen`, `setFormOpen`)
- Replace with event emissions

---

### [P1] Add Basic WebSocket Client Hook

**Status**: Not Started
**Effort**: Small (2 days)
**Dependencies**: WebSocket server
**Spec Reference**: Design Doc §Experiment Detail (real-time updates) • **STATUS Reference**: STATUS-2026-01-04-140535.md §What Can Be Reused? #6

#### Description
Create React hook abstracting WebSocket connection management. Replaces `useExperimentProgress` (SSE-based).

#### Acceptance Criteria
- [ ] `useWebSocket(experimentId)` hook created
- [ ] Hook manages connection lifecycle (connect, disconnect, reconnect)
- [ ] Reconnection logic: exponential backoff, max 5 retries (per clarification)
- [ ] Hook returns `{ data, status, error, reconnect }` where status = 'connecting' | 'connected' | 'disconnected' | 'error'
- [ ] Auto-cleanup on component unmount (unsubscribe, close connection)
- [ ] Visual indicator: `● LIVE` when connected, `○ CONNECTING` when reconnecting, `⚠ OFFLINE` on error
- [ ] Unit tests with mock WebSocket server

#### Technical Notes
**Hook interface**:
```typescript
function useWebSocket<T>(experimentId: string | null): {
  data: T | null;
  status: 'connecting' | 'connected' | 'disconnected' | 'error';
  error: string | null;
  reconnect: () => void;
}
```

**Migration from SSE**:
- Keep `useExperimentProgress` for v1 (don't break it)
- v2 uses `useWebSocket` exclusively
- Can run both during migration phase

---

### [P1] Implement Keyboard Shortcuts System

**Status**: Not Started
**Effort**: Small (2 days)
**Dependencies**: Panel management system
**Spec Reference**: Design Doc §Keyboard Shortcuts • **STATUS Reference**: STATUS-2026-01-04-140535.md §Ambiguities #7

#### Description
Global keyboard shortcut handling with browser conflict avoidance.

**Shortcuts** (per clarification - minimal set):
- `Cmd+P`: Open command palette
- `Cmd+W`: Close current tab
- `Cmd+\`: Toggle left sidebar
- `Cmd+J`: Toggle bottom panel

#### Acceptance Criteria
- [ ] Global keyboard listener with modifier detection (Cmd on Mac, Ctrl on Windows/Linux)
- [ ] Shortcuts work from any focused element
- [ ] Prevent browser default behavior (e.g., Cmd+W closing browser tab)
- [ ] Visual shortcuts shown in tooltips/menus
- [ ] Settings panel shows all shortcuts (read-only for now, no custom mapping)
- [ ] Unit tests for shortcut detection logic

#### Technical Notes
**Library recommendation**: `react-hotkeys-hook` (2KB, battle-tested)

**Browser conflict handling**:
- Cmd+W: Call `event.preventDefault()` to prevent browser tab close
- Cmd+\: No conflict (browser doesn't use this)
- Cmd+J: No conflict
- Cmd+P: Conflicts with Print dialog - document this, may need alternative

**Future enhancement** (P3): Custom shortcut mapping in settings

---

### [P1] Add Basic Toolbar

**Status**: Not Started
**Effort**: Small (1 day)
**Dependencies**: Panel management system
**Spec Reference**: Design Doc §Toolbar • **STATUS Reference**: STATUS-2026-01-04-140535.md §Recommended Implementation Order, Phase 1

#### Description
Slim toolbar at top with Run button, preset picker, sample picker, status indicator.

#### Acceptance Criteria
- [ ] Toolbar component renders above 4-zone layout
- [ ] Run button creates new experiment with selected preset+sample, starts run
- [ ] Preset dropdown shows available presets (built-in + custom)
- [ ] Sample dropdown shows available samples
- [ ] Status indicator shows running/queued counts (display-only, updates via WebSocket)
- [ ] Command palette hint button (⌘P icon)
- [ ] Settings gear opens Settings panel
- [ ] Toolbar state persists (last selected preset/sample)

#### Technical Notes
**Keep toolbar simple** (per design):
- Run button ALWAYS creates new experiment (no context-awareness)
- No "Run selected experiment" - use command palette for that
- Status indicator is display-only (not clickable)

**Toolbar state**:
```typescript
interface ToolbarState {
  selectedPreset: string;   // Default: first preset
  selectedSample: string;   // Default: first sample
}
```

---

## Phase 2: Core Panels (P1)

**Goal**: Primary workflows functional
**Duration**: 3-4 weeks
**Gate**: Can navigate tree → open detail → view logs → inspect run, all in panel UI

---

### [P1] Build Experiment Tree Panel

**Status**: Not Started
**Effort**: Medium (4-5 days)
**Dependencies**: Panel management system
**Spec Reference**: Design Doc §Experiment Tree • **STATUS Reference**: STATUS-2026-01-04-140535.md §Priority 1

#### Description
Hierarchical navigation with collapsible categories. This is the primary navigation UI for the app.

**Current state**: Does NOT exist (v1 has flat grid only)
**Reuse potential**: 10% (filtering logic can inform grouping)

#### Acceptance Criteria
- [ ] Tree component with collapsible categories
- [ ] Three grouping modes: By Status, By Preset, By Sample (default: By Status per clarification)
- [ ] Categories show counts (e.g., "Running (2)", "Completed (12)")
- [ ] Search box filters visible experiments
- [ ] Single-click experiment → emit `onExperimentSelected` event (updates Inspector)
- [ ] Double-click experiment → emit `onExperimentOpenDetail` event (opens Detail tab)
- [ ] Right-click → context menu (Run, Clone, Delete, Mark Baseline)
- [ ] Keyboard navigation (arrow keys, Enter to open, Delete to delete)
- [ ] Tree state persists (which categories expanded, scroll position)
- [ ] Unit tests for grouping logic

#### Technical Notes
**Grouping logic**:
```typescript
// By Status
experiments.groupBy(exp => exp.status)
  → { running: [...], completed: [...], failed: [...], pending: [...] }

// By Preset
experiments.groupBy(exp => exp.preset)
  → { 'quality-openai': [...], 'hybrid': [...], ... }

// By Sample
experiments.groupBy(exp => exp.sample)
  → { 'small-axios': [...], 'tiny-qs': [...], ... }
```

**Default grouping** (per clarification): By Status
**User preference**: NOT stored initially (future enhancement)

**Library recommendation**: `react-complex-tree` or custom implementation (tree is simple enough)

---

### [P1] Build Experiment Detail Tabbed Panel

**Status**: Not Started
**Effort**: Medium (4-5 days)
**Dependencies**: Panel management system, WebSocket client hook
**Spec Reference**: Design Doc §Experiment Detail • **STATUS Reference**: STATUS-2026-01-04-140535.md §Priority 3

#### Description
Detailed experiment view with Config, Runs table, Passes breakdown. Multiple experiments can be open as tabs simultaneously.

**Current state**: Modal implementation exists (445 LOC)
**Reuse potential**: 50% (content/layout good, needs WebSocket migration)

#### Acceptance Criteria
- [ ] DetailPanel component extracted from `ExperimentDetail.tsx` modal
- [ ] Supports multiple instances (each experiment = separate tab)
- [ ] Header: experiment name, Run/Clone/Delete action buttons
- [ ] Config section: preset, sample, created date, baseline status (collapsible)
- [ ] Runs table: all runs with score, duration, tokens, cost, status, started time
- [ ] Click run row → updates Inspector, expands Passes for that run
- [ ] Passes section (per run): pass number, processor, mode, renamed count, duration, tokens
- [ ] Click pass row → updates Inspector
- [ ] Double-click pass → opens log in Bottom zone
- [ ] Real-time updates via WebSocket (● LIVE indicator when connected)
- [ ] Tab can be closed with Cmd+W or close button
- [ ] Unit tests for run/pass display logic

#### Technical Notes
**Real-time updates**:
- Use `useWebSocket(experimentId)` hook
- Updates: run status, pass progress, token counts, costs
- Visual: `● LIVE` in green when connected and run active

**Migration from v1**:
- Extract content from `<Dialog>` wrapper
- Remove modal open/close state management
- Add tab management (can have multiple Detail tabs open)

**Tab lifecycle** (per clarification): No auto-close, user manages manually

---

### [P1] Build Inspector Panel

**Status**: Not Started
**Effort**: Medium (3-4 days)
**Dependencies**: Panel management system, event bus for selection changes
**Spec Reference**: Design Doc §Inspector • **STATUS Reference**: STATUS-2026-01-04-140535.md §Priority 6

#### Description
Context-sensitive right sidebar showing details of current selection (experiment, run, pass, identifier).

**Current state**: Does NOT exist
**Reuse potential**: 20% (identifier detail rendering from `IdentifierContextDialog.tsx`)

#### Acceptance Criteria
- [ ] Inspector panel component created
- [ ] Empty state: "Select an experiment, run, pass, or identifier to inspect"
- [ ] Context: Experiment → shows config, preset details, quick stats (score, runs, cost)
- [ ] Context: Run → shows run metrics, token usage, cost breakdown, duration
- [ ] Context: Pass → shows pass config, renamed count, unchanged count, duration, tokens
- [ ] Context: Identifier → shows original name, new name, confidence, surrounding code context
- [ ] Auto-updates when selection changes (listens to `onExperimentSelected`, `onRunSelected`, etc.)
- [ ] Compact layout (fits in narrow sidebar)
- [ ] Unit tests for context-switching logic

#### Technical Notes
**Event bus** (for selection changes):
```typescript
// Global event emitter
eventBus.emit('selection:experiment', experimentId);
eventBus.emit('selection:run', { experimentId, runId });
eventBus.emit('selection:pass', { experimentId, runId, passId });
eventBus.emit('selection:identifier', { experimentId, runId, passId, identifierId });
```

**Library recommendation**: Custom event bus (simple) or Zustand (if state gets complex)

**Inspector context detection**:
- Track last emitted selection event
- Render appropriate section based on event type

---

### [P1] Build Log Viewer Panel

**Status**: Not Started
**Effort**: Medium (3-4 days)
**Dependencies**: Panel management system, WebSocket client hook
**Spec Reference**: Design Doc §Log Viewer • **STATUS Reference**: STATUS-2026-01-04-140535.md §Priority 8

#### Description
Dedicated log viewer in Bottom zone with filtering, search, real-time streaming. Multiple log streams can be open as tabs.

**Current state**: Logs embedded in detail modal
**Reuse potential**: 20% (log display logic exists)

#### Acceptance Criteria
- [ ] LogViewerPanel component created
- [ ] Tab per experiment run (can have multiple log tabs open)
- [ ] Level filter dropdown (DEBUG, INFO, WARN, ERROR, ALL)
- [ ] Pass filter dropdown (Pass 1, Pass 2, ALL)
- [ ] Text search box (filters visible log lines)
- [ ] Clear logs button
- [ ] Export logs button (downloads as .txt)
- [ ] Auto-scroll when at bottom (sticky scroll)
- [ ] Real-time streaming via WebSocket
- [ ] Log lines formatted: `[timestamp] [level] message`
- [ ] Unit tests for filtering logic

#### Technical Notes
**Real-time streaming**:
- Use `useWebSocket(experimentId)` with message type `log`
- Append new log lines to buffer (max 10,000 lines, then circular buffer)
- Only render visible lines (virtualization for performance)

**Virtualization**: Use `react-window` or `react-virtuoso` for large log lists

**Log buffer management**:
- Max 10,000 lines in memory per tab
- Circular buffer: when full, remove oldest 1,000 lines
- Export function should fetch ALL logs from server (not just buffered)

---

### [P2] Build Settings Panel

**Status**: Not Started
**Effort**: Small (2 days)
**Dependencies**: Panel management system
**Spec Reference**: Design Doc §Toolbar (settings gear) • **STATUS Reference**: STATUS-2026-01-04-140535.md §Recommended Implementation Order

#### Description
Settings panel for configuring app preferences. Opens when clicking settings gear in toolbar.

#### Acceptance Criteria
- [ ] SettingsPanel component created
- [ ] Section: Keyboard Shortcuts (read-only list, shows all shortcuts)
- [ ] Section: Theme (Light, Dark, System - future, just show disabled for now)
- [ ] Section: Default Grouping (By Status, By Preset, By Sample - for Experiment Tree)
- [ ] Section: WebSocket reconnection (show current settings, allow override of max retries)
- [ ] Settings persist to localStorage
- [ ] Unit tests for settings read/write logic

#### Technical Notes
**Settings schema**:
```typescript
interface AppSettings {
  version: string;
  defaultGrouping: 'status' | 'preset' | 'sample';
  theme: 'light' | 'dark' | 'system';  // Not implemented yet
  websocket: {
    maxRetries: number;
    initialDelay: number;
  };
}
```

**Theme support**: Placeholder for future (Phase 4+), just show disabled toggle

---

## Phase 3: Enhanced Navigation (P1-P2)

**Goal**: Keyboard-first workflows
**Duration**: 2-3 weeks
**Gate**: Can complete all workflows via keyboard alone

---

### [P1] Build Command Palette

**Status**: Not Started
**Effort**: Large (5-7 days)
**Dependencies**: Panel management system, all core panels implemented
**Spec Reference**: Design Doc §Command Palette • **STATUS Reference**: STATUS-2026-01-04-140535.md §Priority 9

#### Description
Quicksilver/Raycast-style command palette with action chaining. Opens with Cmd+P.

**Current state**: Does NOT exist
**Reuse potential**: 0%

**Clarification applied**: NOT context-sensitive, uses action chaining instead

#### Acceptance Criteria
- [ ] CommandPalette component created (modal overlay, Cmd+P to open)
- [ ] Fuzzy search filtering (type to filter actions)
- [ ] Action → submenu flow (Tab to drill in, Backspace to go back)
- [ ] Actions defined: Run Experiment, Open Panel, Open Logs, Delete Experiment, Set Preset, Clear Experiments
- [ ] Each action has submenu (e.g., Run Experiment → list of experiments)
- [ ] Enter executes selected action
- [ ] Escape closes palette
- [ ] Arrow keys navigate list
- [ ] Visual breadcrumb shows action chain (e.g., "Run Experiment ▸ exp-023")
- [ ] Recent actions shown at top (MRU)
- [ ] Unit tests for action registry and filtering logic

#### Technical Notes
**Library**: `cmdk` (Raycast uses this, 3KB, battle-tested)

**Action registry**:
```typescript
interface Action {
  id: string;
  label: string;
  keywords: string[];  // For fuzzy search
  submenu?: (query: string) => Promise<Action[]>;
  execute?: () => Promise<void>;
}
```

**Example chains** (per design):
- `Run` → Tab → `exp-023` → Enter (runs exp-023)
- `Open Panel` → Tab → `Metrics` → Enter (opens Metrics Dashboard)
- `Delete` → Tab → `exp-007` → Enter (deletes exp-007)

**Not context-sensitive** (per clarification): All actions available globally, use chaining for specificity

---

### [P2] Add Context Menus

**Status**: Not Started
**Effort**: Small (2 days)
**Dependencies**: Experiment Tree, Experiment Grid, panel management
**Spec Reference**: Design Doc §Experiment Tree interactions • **STATUS Reference**: STATUS-2026-01-04-140535.md §Recommended Implementation Order, Phase 3.3

#### Description
Right-click context menus as backup to keyboard shortcuts.

#### Acceptance Criteria
- [ ] Right-click on Tree item → context menu (Run, Clone, Delete, Mark Baseline, Open Detail)
- [ ] Right-click on Grid row → same context menu
- [ ] Right-click in zone → context menu (Add Panel, Close All Tabs)
- [ ] Context menu visually distinct from browser default (styled)
- [ ] Keyboard accessible (arrow keys navigate, Enter selects, Esc closes)
- [ ] Unit tests for menu actions

#### Technical Notes
**Library**: `react-contexify` or custom implementation (menus are simple)

**Menu items map to actions**:
- Run → Triggers same logic as toolbar Run button
- Clone → Creates duplicate experiment
- Delete → Shows confirmation dialog, then deletes
- Mark Baseline → Sets `baseline: true` flag on experiment
- Open Detail → Opens Detail tab (same as double-click)

---

### [P2] Implement Panel Drag-Drop Between Zones

**Status**: Not Started
**Effort**: Medium (3-4 days)
**Dependencies**: Panel management system
**Spec Reference**: Design Doc §Panel Management • **STATUS Reference**: STATUS-2026-01-04-140535.md §Ambiguities #6

#### Description
Allow panels to be dragged between zones for flexible layout.

**Clarification applied**: Panels CAN move between any zones (no restrictions)

#### Acceptance Criteria
- [ ] Can drag panel header to move panel to different zone
- [ ] Visual drop targets highlight when dragging
- [ ] Drop updates panel state (removes from source zone, adds to target zone)
- [ ] Tab drag-drop also supported (reorder tabs within zone)
- [ ] Drag state persists (panel remembers which zone it's in)
- [ ] Unit tests for drag-drop state transitions

#### Technical Notes
**Library**: Panel library should handle this (e.g., `react-grid-layout` supports drag-drop). If not, use `react-dnd`.

**Edge cases**:
- Dragging last panel from zone → zone collapses
- Dragging to collapsed zone → zone expands
- Dragging tab out of zone → becomes new panel in target zone

---

## Phase 4: Advanced Features (P2)

**Goal**: Complete design spec
**Duration**: 2-3 weeks
**Gate**: All Priority 1-7 panels implemented and functional

---

### [P2] Build Metrics Dashboard Panel

**Status**: Not Started
**Effort**: Large (5-7 days)
**Dependencies**: Panel management system, charting library
**Spec Reference**: Design Doc §Metrics Dashboard • **STATUS Reference**: STATUS-2026-01-04-140535.md §Priority 4

#### Description
Visual overview of performance across experiments with charts and aggregates.

**Current state**: Does NOT exist
**Reuse potential**: 0% (but backend has raw data)

#### Acceptance Criteria
- [ ] MetricsDashboardPanel component created
- [ ] Section: Totals (experiments count, runs count, tokens used, total cost)
- [ ] Chart: Score distribution (histogram, 80-100 range)
- [ ] Chart: Cost by preset (bar chart)
- [ ] Chart: Score over time (line chart, last 30 days)
- [ ] Section: Top performers (leaderboard, top 5 experiments by score)
- [ ] Time range filter (Last 7 days, Last 30 days, All time)
- [ ] Charts update when data changes (WebSocket or polling)
- [ ] Unit tests for aggregate calculations

#### Technical Notes
**Charting library**: Choose one:
- `recharts`: React-friendly, declarative, 50KB
- `chart.js`: Popular, imperative, 60KB
- `visx`: Low-level, Airbnb-maintained, 80KB
- Recommendation: `recharts` (best DX, good enough performance)

**Aggregate queries** (add to backend API):
```typescript
GET /api/metrics/aggregates?timeRange=30d
→ { totalExperiments, totalRuns, totalTokens, totalCost }

GET /api/metrics/score-distribution?timeRange=30d
→ { bins: [{ min: 80, max: 85, count: 2 }, ...] }

GET /api/metrics/cost-by-preset?timeRange=30d
→ { 'quality-openai': 2.10, 'hybrid': 1.80, ... }
```

---

### [P2] Enhance Preset Editor with Visual Pipeline

**Status**: Not Started
**Effort**: Medium (4-5 days)
**Dependencies**: Panel management system, drag-drop library
**Spec Reference**: Design Doc §Preset Editor • **STATUS Reference**: STATUS-2026-01-04-140535.md §Priority 5

#### Description
Visual pass pipeline editor with drag-drop reordering and inline config.

**Current state**: Basic CRUD modal (390 LOC)
**Reuse potential**: 30% (CRUD API calls, basic form structure)

#### Acceptance Criteria
- [ ] PresetEditorPanel component created
- [ ] Pass list shows passes in order with visual connectors (1 → 2 → 3)
- [ ] Drag-drop to reorder passes
- [ ] Click pass → inline editor expands (edit processor, model, mode, concurrency)
- [ ] Add Pass button → adds new pass at end
- [ ] Remove pass button (X) → removes pass from pipeline
- [ ] Built-in presets shown separately (read-only, can clone to edit)
- [ ] Save button → saves preset (validates required fields)
- [ ] Save As button → saves as new preset
- [ ] Unit tests for pass reordering logic

#### Technical Notes
**Visual pipeline**:
```
┌─────────────────────────────────────────┐
│ 1. local-llm    │ 3B │ turbo │ 1 conc  │ [×]
└─────────────────────────────────────────┘
           ↓
┌─────────────────────────────────────────┐
│ 2. openai       │ 4o │ turbo │ 20 conc │ [×]
└─────────────────────────────────────────┘
```

**Drag-drop**: Use `react-beautiful-dnd` (lightweight, good DX)

**Validation**:
- At least one pass required
- Processor + model required per pass
- Concurrency >= 1

---

### [P2] Build Data Management Panel

**Status**: Not Started
**Effort**: Small (2-3 days)
**Dependencies**: Panel management system, backend API
**Spec Reference**: Design Doc §Data Management • **STATUS Reference**: STATUS-2026-01-04-140535.md §Priority 7

#### Description
Admin panel for storage management and bulk operations.

**Current state**: Does NOT exist
**Reuse potential**: 0%

#### Acceptance Criteria
- [ ] DataManagementPanel component created
- [ ] Section: Quick Actions (Clear All Experiments, Clear Completed Only, Clear Failed Only)
- [ ] Section: Storage (shows experiments count/size, logs count/size, checkpoints count/size)
- [ ] Export All Data button → downloads JSON archive
- [ ] Import Data button → uploads JSON archive, restores experiments
- [ ] Section: Danger Zone (Reset Database button with confirmation dialog)
- [ ] All actions show confirmation dialogs
- [ ] Success/error toasts after actions
- [ ] Unit tests for storage calculations

#### Technical Notes
**Backend API additions**:
```typescript
DELETE /api/experiments?status=completed  // Clear completed
DELETE /api/experiments?status=failed     // Clear failed
DELETE /api/experiments                   // Clear all
GET /api/storage/stats                    // Storage usage
POST /api/storage/export                  // Export all data
POST /api/storage/import                  // Import data
POST /api/storage/reset                   // Reset database
```

**Confirmation dialogs**:
- Clear operations: "This will delete N experiments. Continue?"
- Reset database: "This will delete EVERYTHING. Type 'RESET' to confirm."

---

### [P3] Add Collapsible Zone Animations

**Status**: Not Started
**Effort**: Small (1 day)
**Dependencies**: Panel management system
**Spec Reference**: Design Doc §Layout Structure (zones are collapsible) • **STATUS Reference**: STATUS-2026-01-04-140535.md §Recommended Implementation Order

#### Description
Smooth animations when collapsing/expanding zones.

#### Acceptance Criteria
- [ ] Left sidebar collapse animates smoothly (slide out/in, 200ms)
- [ ] Right sidebar collapse animates smoothly
- [ ] Bottom panel collapse animates smoothly (slide down/up)
- [ ] Collapse state persists (zone remembers collapsed state)
- [ ] Keyboard shortcuts work (Cmd+\ for left, Cmd+J for bottom)
- [ ] Visual affordance (collapse arrow icon)

#### Technical Notes
**Animation library**: CSS transitions (native) or `framer-motion` (if already using)

**Collapsed state**:
```typescript
interface ZoneState {
  collapsed: boolean;
  width?: number;  // For left/right (restore on expand)
  height?: number; // For bottom (restore on expand)
}
```

---

## Phase 5: Polish & Testing (P2-P3)

**Goal**: Production-ready
**Duration**: 1-2 weeks
**Gate**: All tests passing, no performance issues, state persists correctly

---

### [P2] Implement State Persistence Versioning

**Status**: Not Started
**Effort**: Small (2 days)
**Dependencies**: Panel management system
**Spec Reference**: Design Doc §State Persistence (upgrade-safe) • **STATUS Reference**: STATUS-2026-01-04-140535.md §Recommended Implementation Order, Phase 5.1

#### Description
Upgrade-safe state persistence with version migrations.

#### Acceptance Criteria
- [ ] WorkspaceState has `version` field (semantic versioning)
- [ ] On load: if version mismatch, run migration or reset to defaults
- [ ] Migration functions defined (v1 → v2, v2 → v3, etc.)
- [ ] Graceful degradation: if migration fails, reset to defaults (don't crash)
- [ ] State schema documented (comments in code)
- [ ] Unit tests for migrations

#### Technical Notes
**Version strategy**:
```typescript
interface WorkspaceState {
  version: string;  // e.g., "1.0.0"
  // ... rest of state
}

// On load
const storedState = localStorage.getItem('workspaceState');
if (storedState) {
  const parsed = JSON.parse(storedState);
  if (parsed.version !== CURRENT_VERSION) {
    // Run migration or reset
    const migrated = migrateState(parsed, CURRENT_VERSION);
    setState(migrated);
  }
}
```

**Migration example**:
```typescript
// v1.0.0 → v1.1.0: Added "collapsed" field to zones
function migrateV1ToV1_1(state: StateV1): StateV1_1 {
  return {
    ...state,
    version: '1.1.0',
    zones: {
      ...state.zones,
      left: { ...state.zones.left, collapsed: false },
      right: { ...state.zones.right, collapsed: false },
      bottom: { ...state.zones.bottom, collapsed: true },
    },
  };
}
```

---

### [P2] Add Testing Infrastructure

**Status**: Not Started
**Effort**: Medium (3-5 days)
**Dependencies**: All panels implemented
**Spec Reference**: CLAUDE.md §Testing • **STATUS Reference**: STATUS-2026-01-04-140535.md §Recommendations #5

#### Description
Comprehensive testing with unit, integration, and E2E tests.

**Current state**: v1 has 0 tests (don't repeat this mistake!)

#### Acceptance Criteria
- [ ] Vitest configured with React Testing Library
- [ ] Unit tests for: panel state management, filtering logic, WebSocket hook, command palette
- [ ] Integration tests for: panel interactions, event bus, keyboard shortcuts
- [ ] E2E tests with Playwright: full workflow (open tree → select experiment → open detail → view logs)
- [ ] Code coverage report (aim for >70%)
- [ ] CI integration (tests run on every commit)
- [ ] Mock WebSocket server for testing

#### Technical Notes
**Test pyramid**:
- 60% unit tests (fast, isolated)
- 30% integration tests (panel interactions)
- 10% E2E tests (critical workflows)

**Key areas to test**:
1. Panel state management (open/close/move/persist)
2. WebSocket reconnection logic (simulate disconnect)
3. Command palette action chains
4. Keyboard shortcuts (simulate key events)
5. Tree grouping/filtering
6. Grid sorting/filtering

**Mock WebSocket**:
```typescript
class MockWebSocket {
  send = vi.fn();
  close = vi.fn();
  addEventListener = vi.fn();
  // ... mock implementation
}
global.WebSocket = MockWebSocket;
```

---

### [P2] Performance Optimization

**Status**: Not Started
**Effort**: Medium (3-4 days)
**Dependencies**: All panels implemented, testing infrastructure
**Spec Reference**: Design Doc (implicit) • **STATUS Reference**: STATUS-2026-01-04-140535.md §Recommended Implementation Order, Phase 5.3

#### Description
Optimize for large datasets (1000+ experiments, large log files).

#### Acceptance Criteria
- [ ] Experiment list virtualization (renders only visible rows, handles 10,000+ experiments)
- [ ] Log viewer virtualization (handles 100,000+ log lines without lag)
- [ ] WebSocket message throttling (max 60 updates/sec, batch updates)
- [ ] Grid pagination (max 100 rows per page)
- [ ] Tree lazy loading (expand category → load children)
- [ ] Memory profiling: no leaks when opening/closing 100+ tabs
- [ ] Performance benchmarks: <100ms to open panel, <16ms per render frame

#### Technical Notes
**Virtualization libraries**:
- Grid: `react-window` or `react-virtuoso`
- Logs: `react-window` (fixed height rows)

**WebSocket throttling**:
```typescript
// Batch updates every 16ms (60fps)
const throttledUpdate = useThrottle((data) => {
  setExperimentData(data);
}, 16);
```

**Memory leak prevention**:
- Clean up WebSocket connections on unmount
- Remove event listeners on unmount
- Clear timers/intervals on unmount
- Use WeakMap for caches

**Benchmarking**: Use React DevTools Profiler to measure render times

---

### [P3] Add Dark Mode Support

**Status**: Not Started
**Effort**: Small (2-3 days)
**Dependencies**: Settings panel
**Spec Reference**: Design Doc (future capability) • **STATUS Reference**: STATUS-2026-01-04-140535.md §Settings Panel

#### Description
Dark mode with system preference detection.

#### Acceptance Criteria
- [ ] Theme setting in Settings panel (Light, Dark, System)
- [ ] System preference auto-detected (`prefers-color-scheme` media query)
- [ ] All panels styled for dark mode (backgrounds, text, borders)
- [ ] Theme persists to localStorage
- [ ] Smooth transition when switching themes (200ms fade)
- [ ] No FOUC (flash of unstyled content) on load

#### Technical Notes
**CSS variables approach**:
```css
:root {
  --bg-primary: #ffffff;
  --text-primary: #000000;
  /* ... */
}

[data-theme="dark"] {
  --bg-primary: #1a1a1a;
  --text-primary: #ffffff;
  /* ... */
}
```

**Theme toggle**:
```typescript
const theme = settings.theme === 'system'
  ? window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'
  : settings.theme;
document.documentElement.setAttribute('data-theme', theme);
```

---

### [P3] Add Experiment Comparison View

**Status**: Not Started
**Effort**: Medium (3-4 days)
**Dependencies**: Panel management system, all core panels
**Spec Reference**: Design Doc (future capability, identifier trace) • **STATUS Reference**: STATUS-2026-01-04-140535.md §Priority 10 (modal exists in v1)

#### Description
Side-by-side comparison of 2+ experiments.

**Current state**: `CompareView.tsx` modal exists in v1
**Reuse potential**: 40% (comparison logic can be adapted)

#### Acceptance Criteria
- [ ] ComparePanel component created
- [ ] Select 2-10 experiments to compare (via command palette or multi-select in grid)
- [ ] Side-by-side table: experiment name, score, tokens, cost, duration, status
- [ ] Diff highlighting (best score in green, worst in red)
- [ ] Expand experiment → shows pass-by-pass comparison
- [ ] Can add/remove experiments from comparison
- [ ] Comparison state persists (can close and reopen with same experiments)

#### Technical Notes
**Command palette integration**:
- Action: "Compare Experiments"
- Submenu: Multi-select experiments (checkboxes)
- Enter → opens Compare panel with selected experiments

**Diff highlighting**:
```typescript
const bestScore = Math.max(...experiments.map(e => e.score));
const worstScore = Math.min(...experiments.map(e => e.score));
// Highlight cell based on value
```

---

## Dependency Graph

```
Foundation (Phase 1)
├─> Panel Library Choice [P0]
│   └─> Panel Management System [P0]
│       ├─> Experiment Grid Panel [P0]
│       ├─> Experiment Tree Panel [P1]
│       ├─> Experiment Detail Panel [P1]
│       ├─> Inspector Panel [P1]
│       ├─> Log Viewer Panel [P1]
│       ├─> Settings Panel [P2]
│       ├─> Metrics Dashboard [P2]
│       ├─> Preset Editor [P2]
│       ├─> Data Management [P2]
│       └─> Compare Panel [P3]
├─> WebSocket Server [P0]
│   └─> WebSocket Client Hook [P1]
│       ├─> Experiment Detail Panel [P1]
│       └─> Log Viewer Panel [P1]
├─> webapp-v2 Scaffold [P0]
├─> Keyboard Shortcuts System [P1]
│   └─> Command Palette [P1]
└─> Toolbar [P1]

Navigation (Phase 3)
├─> Command Palette [P1]
│   └─> Context Menus [P2]
└─> Panel Drag-Drop [P2]

Advanced Features (Phase 4)
├─> Metrics Dashboard [P2]
├─> Preset Editor [P2]
├─> Data Management [P2]
└─> Zone Animations [P3]

Polish (Phase 5)
├─> State Versioning [P2]
├─> Testing Infrastructure [P2]
├─> Performance Optimization [P2]
├─> Dark Mode [P3]
└─> Compare View [P3]
```

---

## Risk Mitigation

### HIGH RISK

**Panel library choice** (make-or-break)
- **Mitigation**: Spend 2-3 days on PoC evaluation with 3+ libraries
- **Validation**: PoC must demonstrate tabs, drag-drop, TypeScript, persistence
- **Gate**: Do NOT proceed to Phase 2 without validated PoC

**State management complexity** (panels + tabs + persistence)
- **Mitigation**: Use battle-tested state library (Zustand recommended)
- **Validation**: Can serialize/deserialize all panel state without errors
- **Testing**: Unit tests for all state transitions (>90% coverage)

**WebSocket scaling** (many clients, long-lived connections)
- **Mitigation**: Connection pooling, heartbeat/ping-pong, auto-reconnect
- **Validation**: Load test with 10+ concurrent experiments
- **Monitoring**: Log connection count, message rate, error rate

### MEDIUM RISK

**Command palette UX** (chaining is non-obvious)
- **Mitigation**: Copy Raycast/Spotlight patterns exactly
- **Validation**: User testing with keyboard-first users
- **Iteration**: Collect feedback, iterate on action organization

**Multiple tabs memory usage** (unconstrained tabs = leak)
- **Mitigation**: Tab limit (20), LRU eviction, explicit close button
- **Validation**: Memory profiling with 100+ tabs open
- **Testing**: Open/close 1000 tabs in loop, check for leaks

**Keyboard shortcut conflicts** (browser vs app)
- **Mitigation**: Use Cmd/Ctrl modifiers, document conflicts
- **Validation**: Test on Mac/Linux/Windows
- **Documentation**: List all shortcuts in Settings panel

### LOW RISK

**Backend compatibility** (existing APIs should work)
- **Mitigation**: Incremental WebSocket addition, keep REST
- **Validation**: Both SSE and WS work during migration
- **Testing**: Integration tests for all API endpoints

**Type safety** (TypeScript reduces surprises)
- **Mitigation**: Keep strict mode enabled
- **Validation**: No `any` types in panel system
- **Code review**: Enforce type safety in PR reviews

---

## Sprint Recommendations

### Sprint 1 (Week 1-2): Foundation Validation
**Goal**: Validate panel architecture

- Panel library evaluation + PoC [P0]
- webapp-v2 scaffold [P0]
- Panel management system [P0]
- **Gate**: Working 4-zone layout with dummy panel

### Sprint 2 (Week 3-4): First Real Panel
**Goal**: Get one panel working end-to-end

- WebSocket server [P0]
- WebSocket client hook [P1]
- Experiment Grid panel [P0]
- Toolbar [P1]
- **Gate**: Can open grid, run experiment, see real-time updates

### Sprint 3 (Week 5-6): Core Panels 1
**Goal**: Primary navigation working

- Experiment Tree panel [P1]
- Inspector panel [P1]
- Keyboard shortcuts [P1]
- **Gate**: Can navigate tree → open detail → inspect

### Sprint 4 (Week 7-8): Core Panels 2
**Goal**: Detail workflow complete

- Experiment Detail panel [P1]
- Log Viewer panel [P1]
- **Gate**: Can open detail → view logs → real-time updates

### Sprint 5 (Week 9-10): Enhanced Navigation
**Goal**: Keyboard-first UX

- Command palette [P1]
- Context menus [P2]
- Panel drag-drop [P2]
- Settings panel [P2]
- **Gate**: All workflows keyboard-accessible

### Sprint 6 (Week 11-12): Advanced Features
**Goal**: Feature completeness

- Metrics Dashboard [P2]
- Preset Editor [P2]
- Data Management [P2]
- Zone animations [P3]
- **Gate**: All Priority 1-7 panels functional

### Sprint 7 (Week 13-14): Polish & Launch
**Goal**: Production-ready

- State versioning [P2]
- Testing infrastructure [P2]
- Performance optimization [P2]
- Dark mode [P3]
- Compare view [P3]
- **Gate**: >70% test coverage, no performance issues

---

## Ambiguities Resolved

| Area | Question | Resolution |
|------|----------|-----------|
| Panel State Persistence | What persists? | Remember open panels/tabs, reset positions each session |
| WebSocket Reconnection | Retry strategy? | Exponential backoff (1s, 2s, 4s, 8s, 16s), max 5 retries |
| Command Palette Scope | Context-sensitive? | NOT context-sensitive, uses action chaining |
| Multiple Tabs Lifecycle | Auto-close? | No auto-close, user manages manually |
| Experiment Tree Grouping | Default grouping? | By Status, user preference NOT stored initially |
| Panel Drag-Drop | Restrict zones? | Panels CAN move between any zones |
| Keyboard Shortcuts | Full map? | Minimal set: Cmd+P, Cmd+W, Cmd+\, Cmd+J |

---

## Next Steps

1. **Review this plan** with stakeholders
2. **Create beads epic** for webapp v2 with work items from this plan
3. **Start Sprint 1**: Panel library evaluation (2-3 days)
4. **Gate decision**: Validate panel system with PoC before Phase 2
5. **Iterate**: This plan will evolve, keep implementation flexible

**Critical Success Factors**:
- Panel library choice (spend time on evaluation)
- WebSocket stability (load testing required)
- State management (avoid centralized bottleneck)
- Testing discipline (write tests first)

**Estimated Timeline**: 10-15 weeks to feature parity + v2 enhancements

**Feature Parity Checkpoint** (end of Sprint 4):
- Can view experiments (Grid + Tree)
- Can open experiment details
- Can run experiments
- Can view logs
- Real-time updates working

**v2 Enhancement Checkpoint** (end of Sprint 6):
- Command palette functional
- Metrics dashboard working
- Visual preset editor
- All panel types implemented
