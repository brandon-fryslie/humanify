"use strict";var e=require("side-channel"),r=require("./utils"),o=require("./formats"),t=Object.prototype.hasOwnProperty,n={brackets:function(e){return e+"[]"},comma:"comma",indices:function(e,r){return e+"["+r+"]"},repeat:function(e){return e}},a=Array.isArray,i=Array.prototype.push,l=function(e,r){i.apply(e,a(r)?r:[r])},s=Date.prototype.toISOString,c=o.default,f={addQueryPrefix:!1,allowDots:!1,allowEmptyArrays:!1,arrayFormat:"indices",charset:"utf-8",charsetSentinel:!1,commaRoundTrip:!1,delimiter:"&",encode:!0,encodeDotInKeys:!1,encoder:r.encode,encodeValuesOnly:!1,filter:void 0,format:c,formatter:o.formatters[c],indices:!1,serializeDate:function(e){return s.call(e)},skipNulls:!1,strictNullHandling:!1},u=function(e){return"string"==typeof e||"number"==typeof e||"boolean"==typeof e||"symbol"==typeof e||"bigint"==typeof e},d={},y=function o(t,n,i,s,c,y,p,m,v,h,w,b,g,D,E,T,k,N){for(var S=t,A=N,I=0,O=!1;void 0!==(A=A.get(d))&&!O;){var K=A.get(t);if(I+=1,void 0!==K){if(K===I)throw new RangeError("Cyclic object value");O=!0}void 0===A.get(d)&&(I=0)}if("function"==typeof h?S=h(n,S):S instanceof Date?S=g(S):"comma"===i&&a(S)&&(S=r.maybeMap(S,function(e){return e instanceof Date?g(e):e})),null===S){if(y)return v&&!T?v(n,f.encoder,k,"key",D):n;S=""}if(u(S)||r.isBuffer(S))return v?[E(T?n:v(n,f.encoder,k,"key",D))+"="+E(v(S,f.encoder,k,"value",D))]:[E(n)+"="+E(String(S))];var j,R=[];if(void 0===S)return R;if("comma"===i&&a(S))T&&v&&(S=r.maybeMap(S,v)),j=[{value:S.length>0?S.join(",")||null:void 0}];else if(a(h))j=h;else{var x=Object.keys(S);j=w?x.sort(w):x}var P=m?String(n).replace(/\./g,"%2E"):String(n),z=s&&a(S)&&1===S.length?P+"[]":P;if(c&&a(S)&&0===S.length)return z+"[]";for(var F=0;F<j.length;++F){var H=j[F],Q="object"==typeof H&&H&&void 0!==H.value?H.value:S[H];if(!p||null!==Q){var V=b&&m?String(H).replace(/\./g,"%2E"):String(H),q=a(S)?"function"==typeof i?i(z,V):z:z+(b?"."+V:"["+V+"]");N.set(t,I);var B=e();B.set(d,N),l(R,o(Q,q,i,s,c,y,p,m,"comma"===i&&T&&a(S)?null:v,h,w,b,g,D,E,T,k,B))}}return R},p=function(e){if(!e)return f;if(void 0!==e.allowEmptyArrays&&"boolean"!=typeof e.allowEmptyArrays)throw new TypeError("`allowEmptyArrays` option can only be `true` or `false`, when provided");if(void 0!==e.encodeDotInKeys&&"boolean"!=typeof e.encodeDotInKeys)throw new TypeError("`encodeDotInKeys` option can only be `true` or `false`, when provided");if(null!==e.encoder&&void 0!==e.encoder&&"function"!=typeof e.encoder)throw new TypeError("Encoder has to be a function.");var r=e.charset||f.charset;if(void 0!==e.charset&&"utf-8"!==e.charset&&"iso-8859-1"!==e.charset)throw new TypeError("The charset option must be either utf-8, iso-8859-1, or undefined");var i=o.default;if(void 0!==e.format){if(!t.call(o.formatters,e.format))throw new TypeError("Unknown format option provided.");i=e.format}var l,s=o.formatters[i],c=f.filter;if(("function"==typeof e.filter||a(e.filter))&&(c=e.filter),l=e.arrayFormat in n?e.arrayFormat:"indices"in e?e.indices?"indices":"repeat":f.arrayFormat,"commaRoundTrip"in e&&"boolean"!=typeof e.commaRoundTrip)throw new TypeError("`commaRoundTrip` must be a boolean, or absent");var u=void 0===e.allowDots?!0===e.encodeDotInKeys||f.allowDots:!!e.allowDots;return{addQueryPrefix:"boolean"==typeof e.addQueryPrefix?e.addQueryPrefix:f.addQueryPrefix,allowDots:u,allowEmptyArrays:"boolean"==typeof e.allowEmptyArrays?!!e.allowEmptyArrays:f.allowEmptyArrays,arrayFormat:l,charset:r,charsetSentinel:"boolean"==typeof e.charsetSentinel?e.charsetSentinel:f.charsetSentinel,commaRoundTrip:!!e.commaRoundTrip,delimiter:void 0===e.delimiter?f.delimiter:e.delimiter,encode:"boolean"==typeof e.encode?e.encode:f.encode,encodeDotInKeys:"boolean"==typeof e.encodeDotInKeys?e.encodeDotInKeys:f.encodeDotInKeys,encoder:"function"==typeof e.encoder?e.encoder:f.encoder,encodeValuesOnly:"boolean"==typeof e.encodeValuesOnly?e.encodeValuesOnly:f.encodeValuesOnly,filter:c,format:i,formatter:s,serializeDate:"function"==typeof e.serializeDate?e.serializeDate:f.serializeDate,skipNulls:"boolean"==typeof e.skipNulls?e.skipNulls:f.skipNulls,sort:"function"==typeof e.sort?e.sort:null,strictNullHandling:"boolean"==typeof e.strictNullHandling?e.strictNullHandling:f.strictNullHandling}};module.exports=function(r,o){var t,i=r,s=p(o);"function"==typeof s.filter?i=(0,s.filter)("",i):a(s.filter)&&(t=s.filter);var c=[];if("object"!=typeof i||null===i)return"";var f=n[s.arrayFormat],u="comma"===f&&s.commaRoundTrip;t||(t=Object.keys(i)),s.sort&&t.sort(s.sort);for(var d=e(),m=0;m<t.length;++m){var v=t[m],h=i[v];s.skipNulls&&null===h||l(c,y(h,v,f,u,s.allowEmptyArrays,s.strictNullHandling,s.skipNulls,s.encodeDotInKeys,s.encode?s.encoder:null,s.filter,s.sort,s.allowDots,s.serializeDate,s.format,s.formatter,s.encodeValuesOnly,s.charset,d))}var w=c.join(s.delimiter),b=!0===s.addQueryPrefix?"?":"";return s.charsetSentinel&&("iso-8859-1"===s.charset?b+="utf8=%26%2310003%3B&":b+="utf8=%E2%9C%93&"),w.length>0?b+w:""};